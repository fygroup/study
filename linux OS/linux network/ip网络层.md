### 内核分层模型
```
                应用程序
                C标准库
用户空间         
-------------------------------------                
内核空间
   应用层       struct socket, struct sock
   传输层       struct proto(TCP, UDP)
   网络层       struct packet_type(IP)         
   主机到网络层  dev.c
                struct net_device
                driver.c
                硬件
```

### Linux从硬件到内部传输
```
https://www.jianshu.com/p/9770fe312453

      OSI七层网络模型     tcp/ip四层模型  网络协议
      +--------------+-----------------+--------------------+
      | application  |                 |  HTTP SNMP FTP     |
      |--------------|                 |  SMTP DNS  Telnet  |
      |presentation  |    application  |                    |
      |--------------|                 |                    |
      |session       |                 |                    |
      |--------------+-----------------+--------------------|
      |transport     |    transport    |  tcp udp           |
      |--------------+-----------------+--------------------|
      |network       |    internet     |  ipv4 ipv6  ICMP   |
      |--------------+-----------------+--------------------|
+-----| datalink     |                 |  ARP RARP PPP      |
|     |--------------|   networkaccess |--------------------|
|     |physical      |                 |ISO2110   iEEE802   |
|     +--------------+-----------------+--------------------+
|
|                 发送                         接收
+----->  数据包发送 dev_queue_xmit()    数据包接收 netif_rx()            网络协议接口层
                         struct net_device                             网络设备接口层
         数据包发送 hard_start_xmit()    中断处理中接收                   设备驱动层
                        物理设备媒介                                    网络设备与媒介层
```

1、数据的接收
```
                   +-----+
                   |     |                            Memory
+--------+   1     |     |  2  DMA     +--------+--------+--------+--------+
| Packet |-------->| NIC |------------>| Packet | Packet | Packet | ...... |
+--------+         |     |             +--------+--------+--------+--------+
                   |     |<--------+
                   +-----+         |
                      |            +---------------+
                      |                            |
                    3 | Raise IRQ                  | Disable IRQ
                      |                          5 |
                      |                            |
                      ↓                            |
                   +-----+                   +------------+
                   |     |  Run IRQ handler  |            |
                   | CPU |------------------>| NIC Driver |
                   |     |       4           |            |
                   +-----+                   +------------+
                                                   |
                                                6  | Raise soft IRQ
                                                   |
                                                   ↓
                                                +-----+
                                        17      |     |
                                   +----------->| NIC |
                                   |            |     |
                                   |Enable IRQ  +-----+
                                   |
                                   |
                             +------------+                                      Memroy
                             |            |        Read           +--------+--------+--------+--------+
            +--------------->| NIC Driver |<--------------------- | Packet | Packet | Packet | ...... |
            |                |            |          9            +--------+--------+--------+--------+
            |                +------------+
            |                      |    |        skb
       Poll | 8      Raise softIRQ | 6  +-----------------+
            |                      |             10       |
            |                      ↓                      ↓
    +---------------+  Call  +-----------+        +------------------+        +--------------------+  12  +---------------------+
    | net_rx_action |<-------| ksoftirqd |        | napi_gro_receive |------->| enqueue_to_backlog |----->| CPU input_pkt_queue |
    +---------------+   7    +-----------+        +------------------+   11   +--------------------+      +---------------------+
                                                          |                                                      | 13
                                                       14 |        + - - - - - - - - - - - - - - - - - - - - - - +
                                                          ↓        ↓
                                               +--------------------------+    15      +------------------------+
                                               | __netif_receive_skb_core |----------->| packet taps(AF_PACKET) | 一些抓包工具
                                               +--------------------------+            +------------------------+
                                                          |
                                                          | 16
                                                          ↓
                                                 +-----------------+
                                                 | protocol layers |
                                                 +-----------------+
                                                        |
                                                        |
                                                        ↓         promiscuous mode &&
                                                    +--------+    PACKET_OTHERHOST (set by driver)   +-----------------+
                                                    | ip_rcv |-------------------------------------->| drop this packet|
                                                    +--------+                                       +-----------------+
                                                        |
                                                        |
                                                        ↓
                                                +---------------------+
                                                | NF_INET_PRE_ROUTING |
                                                +---------------------+
                                                        |
                                                        |
                                                        ↓
                                                    +---------+
                                                    |         | enabled ip forword  +------------+        +----------------+
                                                    | routing |-------------------->| ip_forward |------->| NF_INET_FORWARD |
                                                    |         |                     +------------+        +----------------+
                                                    +---------+                                                   |
                                                        |                                                         |
                                                        | destination IP is local                                 ↓
                                                        ↓                                                 +---------------+
                                                +------------------+                                       | dst_output_sk |
                                                | ip_local_deliver |                                       +---------------+
                                                +------------------+
                                                        |
                                                        |
                                                        ↓
                                                +------------------+
                                                | NF_INET_LOCAL_IN |
                                                +------------------+
                                                        |
                                                        |
                                                        ↓
                                                    +-----------+
                                                    | UDP layer |
                                                    +-----------+
                                                        |
                                                        |
                                                        ↓
                                                    +---------+            +-----------------------+
                                                    | udp_rcv |----------->| __udp4_lib_lookup_skb |
                                                    +---------+            +-----------------------+
                                                        |
                                                        |
                                                        ↓
                                               +--------------------+      +-----------+
                                               | sock_queue_rcv_skb |----->| sk_filter |
                                               +--------------------+      +-----------+
                                                        |
                                                        |
                                                        ↓
                                               +------------------+
                                               | __skb_queue_tail |
                                               +------------------+
                                                        |
                                                        |
                                                        ↓
                                                +---------------+
                                                | sk_data_ready |
                                                +---------------+


//网卡到内存
1： 数据包从外面的网络进入物理网卡。如果目的地址不是该网卡，且该网卡没有开启混杂模式，该包会被网卡丢弃。
2： 网卡将数据包通过DMA的方式写入到指定的内存地址，该地址由网卡驱动分配并初始化。注： 老的网卡可能不支持DMA，不过新的网卡一般都支持。
3： 网卡通过硬件中断（IRQ）通知CPU，告诉它有数据来了
4： CPU根据中断表，调用已经注册的中断函数，这个中断函数会调到驱动程序（NIC Driver）中相应的函数
5： 驱动先禁用网卡的中断，表示驱动程序已经知道内存中有数据了，告诉网卡下次再收到数据包直接写内存就可以了，不要再通知CPU了，这样可以提高效率，避免CPU不停的被中断。
6： 启动软中断。这步结束后，硬件中断处理函数就结束返回了。由于硬中断处理程序执行的过程中不能被中断，所以如果它执行时间过长，会导致CPU没法响应其它硬件的中断，于是内核引入软中断，这样可以将硬中断处理函数中耗时的部分移到软中断处理函数里面来慢慢处理。

//驱动处理内存数据
7： 内核中的ksoftirqd进程专门负责软中断的处理，当它收到软中断后，就会调用相应软中断所对应的处理函数，对于上面第6步中是网卡驱动模块抛出的软中断，ksoftirqd会调用网络模块的net_rx_action函数
8： net_rx_action调用网卡驱动里的poll(sys_poll, io多路复用poll、select都调用这个函数)函数来一个一个的处理数据包
9： 在poll函数中，驱动会一个接一个的读取网卡写到内存中的数据包，内存中数据包的格式只有驱动知道
10： 驱动程序将内存中的数据包转换成内核网络模块能识别的skb格式，然后调用napi_gro_receive函数
11： napi_gro_receive会处理GRO相关的内容，也就是将可以合并的数据包进行合并，这样就只需要调用一次协议栈。然后判断是否开启了RPS，如果开启了，将会调用enqueue_to_backlog
12： 在enqueue_to_backlog函数中，会将数据包放入CPU的softnet_data结构体的input_pkt_queue中，然后返回，如果input_pkt_queue满了的话，该数据包将会被丢弃，queue的大小可以通过net.core.netdev_max_backlog来配置
13： CPU会接着在自己的软中断上下文中处理自己input_pkt_queue里的网络数据（调用__netif_receive_skb_core）
14： 如果没开启RPS，napi_gro_receive会直接调用__netif_receive_skb_core
15： 看是不是有AF_PACKET类型的socket（也就是我们常说的原始套接字），如果有的话，拷贝一份数据给它。tcpdump抓包就是抓的这里的包。
16： 调用协议栈相应的函数，将数据包交给协议栈处理。
17： 待内存中的所有数据包被处理完成后（即poll函数执行完成），启用网卡的硬中断，这样下次网卡再收到数据的时候就会通知CPU


//协议栈（开始进入ip层了）
//ip
ip_rcv： ip_rcv函数是IP模块的入口函数，在该函数里面，第一件事就是将垃圾数据包（目的mac地址不是当前网卡，但由于网卡设置了混杂模式而被接收进来）直接丢掉，然后调用注册在NF_INET_PRE_ROUTING上的函数
NF_INET_PRE_ROUTING： netfilter放在协议栈中的钩子，可以通过iptables来注入一些数据包处理函数，用来修改或者丢弃数据包，如果数据包没被丢弃，将继续往下走
routing： 进行路由，如果是目的IP不是本地IP，且没有开启ip forward功能，那么数据包将被丢弃，如果开启了ip forward功能，那将进入ip_forward函数
ip_forward： ip_forward会先调用netfilter注册的NF_INET_FORWARD相关函数，如果数据包没有被丢弃，那么将继续往后调用dst_output_sk函数
dst_output_sk： 该函数会调用IP层的相应函数将该数据包发送出去，同下一篇要介绍的数据包发送流程的后半部分一样。
ip_local_deliver：如果上面routing的时候发现目的IP是本地IP，那么将会调用该函数，在该函数中，会先调用NF_INET_LOCAL_IN相关的钩子程序，如果通过，数据包将会向下发送到UDP层
//udp
udp_rcv： udp_rcv函数是UDP模块的入口函数，它里面会调用其它的函数，主要是做一些必要的检查，其中一个重要的调用是__udp4_lib_lookup_skb，该函数会根据目的IP和端口找对应的socket，如果没有找到相应的socket，那么该数据包将会被丢弃，否则继续
sock_queue_rcv_skb： 主要干了两件事，一是检查这个socket的receive buffer是不是满了，如果满了的话，丢弃该数据包，然后就是调用sk_filter看这个包是否是满足条件的包，如果当前socket上设置了filter，且该包不满足条件的话，这个数据包也将被丢弃（在Linux里面，每个socket上都可以像tcpdump里面一样定义filter，不满足条件的数据包将会被丢弃）
__skb_queue_tail： 将数据包放入socket接收队列的末尾
sk_data_ready： 通知socket数据包已经准备好

```

2、数据的发送
```

```


### 虚拟网络设备
1、tun/tap
```
tun/tap设备的用处是将协议栈中的部分数据包转发给用户空间的应用程序，给用户空间的程序一个处理数据包的机会。于是比较常用的数据压缩，加密等功能就可以在应用程序B里面做进去，tun/tap设备最常用的场景是VPN

                        
+----------------------------------------------------------------+
|                                                                |
|  +--------------------+      +--------------------+            |
|  | User Application A |      | User Application B |<-----+     |
|  +--------------------+      +--------------------+      |     |
|               | 1                    | 5                 |     |
|...............|......................|...................|.....|
|               ↓                      ↓                   |     |
|         +----------+           +----------+              |     |
|         | socket A |           | socket B |              |     |
|         +----------+           +----------+              |     |
|                 | 2               | 6                    |     |
|.................|.................|......................|.....|
|                 ↓                 ↓                      |     |
|             +------------------------+                 4 |     |
|             | Newwork Protocol Stack |                   |     |
|             +------------------------+                   |     |
|                | 7                 | 3                   |     |
|................|...................|.....................|.....|
|                ↓                   ↓                     |     |
|        +----------------+    +----------------+          |     |
|        |      eth0      |    |      tun0      |          |     |
|        +----------------+    +----------------+          |     |
|    10.32.0.11  |                   |   192.168.3.11      |     |
|                | 8                 +---------------------+     |
|                |                                               |
+----------------|-----------------------------------------------+
                 ↓
         Physical Network


应用程序A是一个普通的程序，通过socket A发送了一个数据包，假设这个数据包的目的IP地址是192.168.3.1

socket将这个数据包丢给协议栈

协议栈根据数据包的目的IP地址，匹配本地路由规则，知道这个数据包应该由tun0出去，于是将数据包交给tun0

tun0收到数据包之后，发现另一端被进程B打开了，于是将数据包丢给了进程B

进程B收到数据包之后，做一些跟业务相关的处理，然后构造一个新的数据包，将原来的数据包嵌入在新的数据包中，最后通过socket B将数据包转发出去，这时候新数据包的源地址变成了eth0的地址，而目的IP地址变成了一个其它的地址，比如是10.33.0.1.

socket B将数据包丢给协议栈

协议栈根据本地路由，发现这个数据包应该要通过eth0发送出去，于是将数据包交给eth0

eth0通过物理网络将数据包发送出去
```

